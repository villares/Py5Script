<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Py5Script Viewer</title>
    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { background: #000; overflow: hidden; }
        #runner-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            opacity: 0.2;
            transition: opacity 0.3s;
        }
        #controls:hover { opacity: 1; }
        #console-overlay {
            position: fixed;
            bottom: 50px;
            right: 10px;
            width: 400px;
            height: 200px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #444;
            display: none;
            flex-direction: column;
            color: #ddd;
            font-family: monospace;
            font-size: 12px;
            overflow: hidden;
            border-radius: 4px;
        }
        #console-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            white-space: pre-wrap;
        }
        .log-error { color: #ff5555; }
        .log-print { color: #ddd; }
    </style>
</head>
<body>

    <div id="runner-container">
        <iframe id="runner-frame"></iframe>
    </div>

    <div id="console-overlay">
        <div style="padding: 5px; background: #333; border-bottom: 1px solid #444; display: flex; justify-content: space-between;">
            <strong>Console</strong>
            <span style="cursor: pointer;" onclick="document.getElementById('console-overlay').style.display='none'">âœ–</span>
        </div>
        <div id="console-content"></div>
    </div>

    <div id="controls">
        <button id="edit-btn" title="Edit in IDE">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> Edit
        </button>
        <button id="console-btn" title="Toggle Console">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
        </button>
    </div>

    <script src="js/project_manager.js"></script>
    <script>
        const iframe = document.getElementById('runner-frame');
        const consoleContent = document.getElementById('console-content');
        const consoleOverlay = document.getElementById('console-overlay');
        
        // --- CONSOLE LOGIC ---
        function logToConsole(msg, type) {
            const el = document.createElement('span');
            el.textContent = msg + '\n';
            el.className = type === 'error' ? 'log-error' : 'log-print';
            consoleContent.appendChild(el);
            consoleContent.scrollTop = consoleContent.scrollHeight;
            
            // Auto-show on error
            if (type === 'error') {
                consoleOverlay.style.display = 'flex';
            }
        }

        window.addEventListener('message', (event) => {
             const data = event.data;
             if (data && data.type === 'print') {
                 logToConsole(data.message, 'print');
             } else if (data && data.type === 'error') {
                 logToConsole(data.message, 'error');
             }
        });

        document.getElementById('console-btn').addEventListener('click', () => {
             consoleOverlay.style.display = consoleOverlay.style.display === 'flex' ? 'none' : 'flex';
        });

        document.getElementById('edit-btn').addEventListener('click', () => {
             const params = new URLSearchParams(window.location.search);
             let dest = 'ide.html';
             
             if (params.has('sketch') || params.has('zip') || params.has('code')) {
                 // Forward external components, strip 'id' if present (e.g. invalid combo)
                 // Or just pass exact search? Pass exact search is safest unless ID conflicts.
                 // But ide.html logic currently prioritizes ID if valid.
                 // So we should STRIP 'id' if we are in External mode.
                 params.delete('id');
                 dest += '?' + params.toString();
             } else if (projectId && !projectId.startsWith('view-')) {
                 // Existing Project
                 dest += '?id=' + projectId;
             }
             
             window.location.href = dest;
        });

        // --- RUNNER ---
        async function initView() {
            const params = new URLSearchParams(window.location.search);
            const idParam = params.get('id');

            // 1. External Loading (Priority 1)
            // If ?sketch=, ?zip=, or ?code= is present, we create a TEMP session.
            if (params.has('sketch') || params.has('zip') || params.has('code')) {
                // Determine source ID (temp)
                projectId = 'view-' + Date.now();
                
                await loadProjectFromURL({
                     onImport: (msg) => logToConsole(msg, 'print'),
                     onError: (msg) => logToConsole(msg, 'error'),
                     onLoaded: () => {
                         // Save to TEMP Scoped Storage so runner can find it
                         saveProjectAndFiles();
                         runSketch();
                     }
                });
                return;
            }

            // 2. Existing Project (Priority 2)
            if (idParam) {
                projectId = idParam;
                
                // Check if exists in Storage
                const keyFiles = `${PROJECT_KEY_PREFIX}${projectId}_files`;
                const savedFiles = localStorage.getItem(keyFiles);
                
                if (savedFiles) {
                    try {
                        projectFiles = JSON.parse(savedFiles);
                        // Do NOT saveProjectAndFiles(). We treat this as Read-Only.
                        // Runner will load from the SAME key we just checked.
                        runSketch();
                    } catch(e) {
                         console.error("Error loading project files", e);
                         logToConsole(`Error loading project '${idParam}': Corrupt data.`, 'error');
                    }
                } else {
                    logToConsole(`Project '${idParam}' not found.`, 'error');
                }
                return;
            }
            
            // 3. No Params -> Error
            logToConsole("No project or sketch specified in URL.", "print");
        }

        function runSketch() {
             // Find main file
             let code = projectFiles['sketch.py'];
             if (!code && Object.keys(projectFiles).length > 0) {
                 code = projectFiles[Object.keys(projectFiles)[0]];
             }
             
             if(code || Object.keys(projectFiles).length > 0) {
                 // We don't need to pass code in window.name if we use ID hydration!
                 // But runner supports both.
                 // Let's pass code for backward comp, but ID is critical for assets.
                 iframe.contentWindow.name = code || "";
                 
                 // Pass 'case' parameter if present
                 const params = new URLSearchParams(window.location.search);
                 const caseParam = params.get('case');
                 
                 let runnerUrl = 'runner.html?t=' + Date.now();
                 if (caseParam) {
                     runnerUrl += '&case=' + caseParam;
                 }
                 
                 // Pass Project ID
                 runnerUrl += '&id=' + projectId;
                 
                 iframe.src = runnerUrl;
             }
        }

        initView();

    </script>
</body>
</html>
